package ${package.ServiceImpl};

import ${package.Entity}.${entity};
import ${package.Mapper}.${table.mapperName};
#if(${generateService})
import ${package.Service}.${table.serviceName};
#end
import ${superServiceImplClassPackage};
import org.springframework.stereotype.Service;

/**
 * <p>
 * $!{table.comment} 服务实现类
 * </p>
 *
 * @author ${author}
 * @since ${date}
 */
@Service
#if(${enhancer})
public class ${table.serviceImplName} extends ${superServiceImplClass}<${table.mapperName}, ${entity}> implements#if(${generateService}) ${table.serviceName},#end EnhancedService<${entityVO}> {
#else
public class ${table.serviceImplName} extends ${superServiceImplClass}<${table.mapperName}, ${entity}>#if(${generateService}) implements ${table.serviceName}#end {
#end
#if(${methodOverride})
    #if(${generateQuery}||${generateExport})
    
    #if(${showOverrideAnnotation})@Override#end
    public ${entityVO} voById(Serializable id) {
        #if(${enhancer})
        return ${superMehtod}.voById(id);
        #else
        HashMap<String, Object> map = new HashMap<>();
        map.put(TableInfoHelper.getTableInfo(getEntityClass()).getKeyProperty(), id);
        IPage<${entityVO}> page = new Page<>(1L, 1L);
        List<${entityVO}> vs = getBaseMapper().voQuery(map, page);
        if (vs == null || vs.isEmpty()) return null;
        if (page.getTotal() > 1) throw new TooManyResultsException("Expected one result (or null) to be returned by id, but found:" + page.getTotal());
        return vs.get(0);
        #end
    }

    #if(${showOverrideAnnotation})@Override#end
    public List<${entityVO}> voList(${entityQueryDTO} param) {
        #if(${enhancer})
        return ${superMehtod}.voList(param);
        #else
        return getBaseMapper().voQuery(param, null);
        #end
    }

    #if(${showOverrideAnnotation})@Override#end
    public IPage<${entityVO}> voPage(${entityQueryDTO} param, Long current, Long size) {
        #if(${enhancer})
        return ${superMehtod}.voPage(param, current, size);
        #else
        if (current == null || current < 1) current = 1L;
        if (size == null) size = 10L;
        Page<${entityVO}> page = new Page<>(current, size);
        List<${entityVO}> voList = getBaseMapper().voQuery(param, page);
        page.setRecords(voList);
        return page;
        #end
    }
    #end
    #if(${generateExport})

    #if(${showOverrideAnnotation})@Override#end
    public void excelExport(${entityQueryDTO} param, OutputStream os, Class<?> clazz, Long current, Long size, String... includeFields) {
        #if(${enhancer})
        ${superMehtod}.excelExport(param, os, clazz, current, size, includeFields);
        #else
        List<${entityVO}> voList = this.voPage(param, current, size).getRecords();
        ${excelClass}.write(os, clazz).includeColumnFieldNames(Arrays.asList(includeFields)).registerWriteHandler(new LongestMatchColumnWidthStyleStrategy()).sheet().doWrite(voList);
        #end
    }
    #end
    #if(${generateImport})

    #if(${showOverrideAnnotation})@Override#end
    public void excelTemplate(OutputStream os, Class<?> clazz) {
        #if(${enhancer})
        ${superMehtod}.excelTemplate(os, clazz);
        #else
        ${excelClass}.write(os, clazz).sheet().doWrite(Collections.emptyList());
        #end
    }

    #if(${showOverrideAnnotation})@Override#end
    public int excelImport(InputStream is, Class<?> clazz) {
        #if(${enhancer})
//        List<${entityInsertDTO}> dataList = ${excelClass}.read(is).head(clazz).sheet().doReadSync();
        return ${superMehtod}.excelImport(is, clazz);
        #else
        List<?> dataList = ${excelClass}.read(is).head(clazz).sheet().doReadSync();
        List<${entity}> entityList = dataList.stream().map(e -> {
//            ${entityInsertDTO} dto = (${entityInsertDTO}) e;
            ${entity} entity = new ${entity}();
            BeanUtils.copyProperties(e, entity);
            return entity;
        }).collect(Collectors.toList());
        super.saveBatch(entityList);
        return entityList.size();
        #end
    }
    #end
    #if(${generateInsert})

    #if(${showOverrideAnnotation})@Override#end
    public Object insertByDTO(Object param) {
//        ${sourceEntityInsertDTO} dto = (${sourceEntityInsertDTO}) param;
        #if(${enhancer})
        return ${superMehtod}.insertByDTO(param);    
        #else
        ${entity} entity = new ${entity}();
        BeanUtils.copyProperties(param, entity);
        super.save(entity);
        TableInfo tableInfo = TableInfoHelper.getTableInfo(getEntityClass());
        return tableInfo.getPropertyValue(entity, tableInfo.getKeyProperty());
        #end
    }
    #end
    #if(${generateUpdate})

    #if(${showOverrideAnnotation})@Override#end
    public boolean updateByDTO(Object param) {
//        ${sourceEntityUpdateDTO} dto = (${sourceEntityUpdateDTO}) param;
        #if(${enhancer})
        return ${superMehtod}.updateByDTO(param);
        #else
        ${entity} entity = new ${entity}();
        BeanUtils.copyProperties(param, entity);
        return super.updateById(entity);
        #end
    }
    #end
    #if(${generateDelete})

    @Override
    public boolean removeById(Serializable id) {
        return super.removeById(id);
    }
    #end
#end
}
